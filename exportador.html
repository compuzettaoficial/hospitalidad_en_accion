<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exportar Firebase ‚Üí JSON</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: monospace;
            background: #0f172a;
            color: #e2e8f0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        h1 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            border-bottom: 3px solid #3b82f6;
            padding-bottom: 10px;
            color: #60a5fa;
        }
        .section {
            background: #1e293b;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 1px solid #334155;
        }
        .collection-card {
            background: #0f172a;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 6px;
            border-left: 4px solid #3b82f6;
        }
        .collection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .collection-name {
            font-size: 1.2rem;
            color: #60a5fa;
            font-weight: bold;
        }
        .count {
            background: #3b82f6;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            font-weight: bold;
            cursor: pointer;
            margin-right: 10px;
            margin-top: 10px;
            border-radius: 6px;
            font-family: monospace;
            transition: all 0.2s;
        }
        button:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }
        button:disabled {
            background: #475569;
            cursor: not-allowed;
            transform: none;
        }
        .btn-success {
            background: #10b981;
        }
        .btn-success:hover {
            background: #059669;
        }
        .btn-warning {
            background: #f59e0b;
        }
        .btn-warning:hover {
            background: #d97706;
        }
        .preview {
            background: #0f172a;
            padding: 15px;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 0.85rem;
            margin-top: 15px;
            border: 1px solid #334155;
        }
        .preview pre {
            margin: 0;
            color: #94a3b8;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stat-box {
            background: #0f172a;
            padding: 20px;
            text-align: center;
            border-radius: 6px;
            border: 1px solid #334155;
        }
        .stat-num {
            font-size: 2.5rem;
            font-weight: bold;
            color: #60a5fa;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9rem;
            color: #94a3b8;
        }
        .log {
            background: #0f172a;
            padding: 15px;
            margin-top: 15px;
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #334155;
        }
        .log-item {
            padding: 5px 0;
            font-size: 0.85rem;
            border-bottom: 1px solid #1e293b;
        }
        .log-item:last-child {
            border-bottom: none;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .info { color: #60a5fa; }
        .warning { color: #f59e0b; }
        .loading {
            display: inline-block;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .badge {
            display: inline-block;
            background: #1e293b;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 10px;
            color: #94a3b8;
        }
        .export-all {
            text-align: center;
            margin-top: 30px;
        }
        .export-all button {
            font-size: 1.1rem;
            padding: 15px 40px;
        }
        .field-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        .field-tag {
            background: #334155;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            color: #cbd5e1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì• EXPORTADOR FIREBASE ‚Üí JSON</h1>
        
        <div class="section">
            <h2 style="color: #60a5fa; margin-bottom: 20px;">üìä Colecciones Disponibles</h2>
            
            <div class="collection-card">
                <div class="collection-header">
                    <div>
                        <div class="collection-name">üè® hoteles-chimbote-2026</div>
                        <span class="badge" id="hotelesTimestamp">Cargando...</span>
                    </div>
                    <span class="count" id="hotelesCount">0</span>
                </div>
                
                <div class="field-list" id="hotelesFields"></div>
                
                <div style="margin-top: 15px;">
                    <button onclick="exportarColeccion('hoteles-chimbote-2026', 'hoteles')" id="btnHoteles">
                        üì• Descargar Hoteles JSON
                    </button>
                    <button class="btn-success" onclick="verPreview('hoteles-chimbote-2026', 'previewHoteles')">
                        üëÅÔ∏è Vista Previa
                    </button>
                    <button class="btn-warning" onclick="copiarAlPortapapeles('hoteles-chimbote-2026')">
                        üìã Copiar al Portapapeles
                    </button>
                </div>
                
                <div class="preview" id="previewHoteles" style="display: none;"></div>
            </div>
            
            <div class="collection-card">
                <div class="collection-header">
                    <div>
                        <div class="collection-name">üöó cocheras-chimbote-2026</div>
                        <span class="badge" id="cocherasTimestamp">Cargando...</span>
                    </div>
                    <span class="count" id="cocherasCount">0</span>
                </div>
                
                <div class="field-list" id="cocherasFields"></div>
                
                <div style="margin-top: 15px;">
                    <button onclick="exportarColeccion('cocheras-chimbote-2026', 'cocheras')" id="btnCocheras">
                        üì• Descargar Cocheras JSON
                    </button>
                    <button class="btn-success" onclick="verPreview('cocheras-chimbote-2026', 'previewCocheras')">
                        üëÅÔ∏è Vista Previa
                    </button>
                    <button class="btn-warning" onclick="copiarAlPortapapeles('cocheras-chimbote-2026')">
                        üìã Copiar al Portapapeles
                    </button>
                </div>
                
                <div class="preview" id="previewCocheras" style="display: none;"></div>
            </div>
            
            <div class="export-all">
                <button onclick="exportarTodo()" class="btn-success">
                    üì¶ DESCARGAR TODO (ZIP)
                </button>
            </div>
        </div>
        
        <div class="section">
            <h2 style="color: #60a5fa; margin-bottom: 15px;">üìà Estad√≠sticas</h2>
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-num" id="totalDocs">0</div>
                    <div class="stat-label">Total Documentos</div>
                </div>
                <div class="stat-box">
                    <div class="stat-num" id="totalSize">0 KB</div>
                    <div class="stat-label">Tama√±o Total</div>
                </div>
                <div class="stat-box">
                    <div class="stat-num success" id="lastUpdate">--</div>
                    <div class="stat-label">√öltima Actualizaci√≥n</div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2 style="color: #60a5fa; margin-bottom: 15px;">üìù Log de Actividad</h2>
            <div class="log" id="logContainer">
                <div class="log-item info">Sistema iniciado. Conectando a Firebase...</div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBFaCbNqpd93Eirj7NDnkKtOS6Ym0rMoiA",
            authDomain: "hospitalidad-29c5c.firebaseapp.com",
            projectId: "hospitalidad-29c5c"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        let cacheDatos = {
            hoteles: [],
            cocheras: []
        };
        
        function log(mensaje, tipo = 'info') {
            const container = document.getElementById('logContainer');
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = `log-item ${tipo}`;
            div.innerHTML = `<strong>[${time}]</strong> ${mensaje}`;
            container.insertBefore(div, container.firstChild);
            
            // Mantener solo √∫ltimos 20 logs
            while (container.children.length > 20) {
                container.removeChild(container.lastChild);
            }
        }
        
        async function cargarDatos() {
            try {
                log('üîÑ Cargando datos desde Firebase...', 'info');
                
                // Cargar hoteles
                const hotelesSnap = await db.collection('hoteles-chimbote-2026').get();
                cacheDatos.hoteles = hotelesSnap.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Cargar cocheras
                const cocherasSnap = await db.collection('cocheras-chimbote-2026').get();
                cacheDatos.cocheras = cocherasSnap.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Actualizar UI
                document.getElementById('hotelesCount').textContent = cacheDatos.hoteles.length;
                document.getElementById('cocherasCount').textContent = cacheDatos.cocheras.length;
                document.getElementById('totalDocs').textContent = cacheDatos.hoteles.length + cacheDatos.cocheras.length;
                
                // Calcular tama√±o
                const totalSize = (JSON.stringify(cacheDatos).length / 1024).toFixed(2);
                document.getElementById('totalSize').textContent = `${totalSize} KB`;
                
                // √öltima actualizaci√≥n
                const allDates = [...cacheDatos.hoteles, ...cacheDatos.cocheras]
                    .map(item => item.metadata?.fechaModificacion || item.metadata?.fechaCreacion)
                    .filter(Boolean)
                    .sort()
                    .reverse();
                
                if (allDates.length > 0) {
                    const lastDate = new Date(allDates[0]);
                    document.getElementById('lastUpdate').textContent = lastDate.toLocaleDateString();
                    document.getElementById('hotelesTimestamp').textContent = `Actualizado: ${lastDate.toLocaleDateString()}`;
                    document.getElementById('cocherasTimestamp').textContent = `Actualizado: ${lastDate.toLocaleDateString()}`;
                }
                
                // Mostrar campos
                mostrarCampos('hoteles', 'hotelesFields');
                mostrarCampos('cocheras', 'cocherasFields');
                
                log(`‚úÖ Datos cargados: ${cacheDatos.hoteles.length} hoteles, ${cacheDatos.cocheras.length} cocheras`, 'success');
                
            } catch (error) {
                log(`‚ùå Error cargando datos: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        function mostrarCampos(tipo, elementId) {
            const datos = cacheDatos[tipo];
            if (datos.length === 0) return;
            
            const campos = new Set();
            datos.forEach(item => {
                Object.keys(item).forEach(key => {
                    if (key !== 'id') campos.add(key);
                });
            });
            
            const container = document.getElementById(elementId);
            container.innerHTML = Array.from(campos)
                .map(campo => `<span class="field-tag">${campo}</span>`)
                .join('');
        }
        
        async function exportarColeccion(coleccion, tipo) {
            const btn = document.getElementById(`btn${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
            btn.disabled = true;
            btn.innerHTML = '<span class="loading">‚è≥</span> Exportando...';
            
            try {
                log(`üì¶ Exportando ${tipo}...`, 'info');
                
                const datos = cacheDatos[tipo];
                
                // Limpiar IDs de Firebase (opcional)
                const datosLimpios = datos.map(item => {
                    const { id, ...resto } = item;
                    return resto;
                });
                
                // Crear JSON
                const jsonStr = JSON.stringify(datosLimpios, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // Descargar
                const link = document.createElement('a');
                link.href = url;
                link.download = `${coleccion}-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                
                log(`‚úÖ ${tipo} exportado exitosamente (${datos.length} items)`, 'success');
                
            } catch (error) {
                log(`‚ùå Error exportando ${tipo}: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = `üì• Descargar ${tipo.charAt(0).toUpperCase() + tipo.slice(1)} JSON`;
            }
        }
        
        async function verPreview(coleccion, previewId) {
            const previewDiv = document.getElementById(previewId);
            const tipo = coleccion.includes('hoteles') ? 'hoteles' : 'cocheras';
            
            if (previewDiv.style.display === 'block') {
                previewDiv.style.display = 'none';
                return;
            }
            
            const datos = cacheDatos[tipo];
            const datosLimpios = datos.map(({ id, ...resto }) => resto);
            const jsonStr = JSON.stringify(datosLimpios, null, 2);
            
            previewDiv.innerHTML = `<pre>${jsonStr.substring(0, 2000)}${jsonStr.length > 2000 ? '\n\n... (truncado, descarga para ver completo)' : ''}</pre>`;
            previewDiv.style.display = 'block';
            
            log(`üëÅÔ∏è Mostrando preview de ${tipo}`, 'info');
        }
        
        async function copiarAlPortapapeles(coleccion) {
            const tipo = coleccion.includes('hoteles') ? 'hoteles' : 'cocheras';
            const datos = cacheDatos[tipo];
            const datosLimpios = datos.map(({ id, ...resto }) => resto);
            const jsonStr = JSON.stringify(datosLimpios, null, 2);
            
            try {
                await navigator.clipboard.writeText(jsonStr);
                log(`üìã JSON de ${tipo} copiado al portapapeles`, 'success');
                alert(`‚úÖ JSON de ${tipo} copiado!\n\nPuedes pegarlo directamente en tu c√≥digo o archivo.`);
            } catch (error) {
                log(`‚ùå Error copiando: ${error.message}`, 'error');
                // Fallback: mostrar en textarea
                const textarea = document.createElement('textarea');
                textarea.value = jsonStr;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                log(`üìã JSON copiado usando m√©todo alternativo`, 'success');
            }
        }
        
        async function exportarTodo() {
            log('üì¶ Creando archivo ZIP con todos los datos...', 'info');
            
            try {
                const zip = new JSZip();
                
                // Agregar hoteles
                const hotelesLimpios = cacheDatos.hoteles.map(({ id, ...resto }) => resto);
                zip.file('hoteles-chimbote-2026.json', JSON.stringify(hotelesLimpios, null, 2));
                
                // Agregar cocheras
                const cocherasLimpias = cacheDatos.cocheras.map(({ id, ...resto }) => resto);
                zip.file('cocheras-chimbote-2026.json', JSON.stringify(cocherasLimpias, null, 2));
                
                // Agregar README
                const readme = `# Datos Exportados - Convenci√≥n AMIP Chimbote 2026

Fecha de exportaci√≥n: ${new Date().toISOString()}

## Contenido:
- hoteles-chimbote-2026.json (${cacheDatos.hoteles.length} items)
- cocheras-chimbote-2026.json (${cacheDatos.cocheras.length} items)

## Uso:
Estos archivos pueden ser:
1. Subidos directamente a GitHub
2. Usados en tu aplicaci√≥n web
3. Re-importados a Firebase si es necesario

Generado por: Exportador Firebase ‚Üí JSON
`;
                zip.file('README.md', readme);
                
                // Generar y descargar ZIP
                const content = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(content);
                const link = document.createElement('a');
                link.href = url;
                link.download = `chimbote-2026-completo-${new Date().toISOString().split('T')[0]}.zip`;
                link.click();
                
                URL.revokeObjectURL(url);
                
                log('‚úÖ ZIP descargado exitosamente con todos los datos', 'success');
                
            } catch (error) {
                log(`‚ùå Error creando ZIP: ${error.message}`, 'error');
            }
        }
        
        // Cargar datos al iniciar
        window.addEventListener('DOMContentLoaded', () => {
            cargarDatos();
            
            // Recargar cada 30 segundos
            setInterval(() => {
                log('üîÑ Recargando datos autom√°ticamente...', 'info');
                cargarDatos();
            }, 30000);
        });
        
        // Bot√≥n para recargar manual
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
                e.preventDefault();
                cargarDatos();
            }
        });
    </script>
</body>
</html>
